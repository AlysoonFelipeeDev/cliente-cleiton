<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gerador de Laudo / Orçamento</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: Arial, Helvetica, sans-serif; background: #f3f4f6; margin: 0; padding: 24px; }
        .app { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; }
        .panel { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,.06); width: 420px; flex-shrink:0; }
        label { display:block; font-size:13px; color:#333; margin-top:10px; }
        input[type=text], textarea, select { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; margin-top:6px; font-size:14px; }
        textarea { min-height:120px; resize:vertical; }
        .row { display:flex; gap:8px; }
        .btn { display:inline-block; padding:10px 14px; border-radius:8px; background:#0b6; color:#fff; border:none; cursor:pointer; margin-top:12px; }
        .btn.ghost { background:#fff; color:#111; border:1px solid #ccc; }
        .preview { flex:1; min-width:360px; }
        .paper { width:210mm; min-height:297mm; background:#fff; padding:20mm; border:1px solid #ddd; border-radius:4px; position:relative; }
        .header { display:flex; align-items:center; border-bottom:2px solid #000; padding-bottom:12px; margin-bottom:20px; }
        .header img { height:150px; }
        .header .company { font-weight:bold; font-size:20px; margin-left:10px; }
        .title-row { display:flex; justify-content:space-between; align-items:center; }
        .title { font-size:18px; font-weight:bold; text-transform:uppercase; }
        .section { margin-top:12px; font-size:14px; }
        .risco { border:solid 1px; margin:10px 0; }
        .footer-container { position:absolute; bottom:20mm; left:20mm; right:20mm; text-align:center; }
        .risco-top { margin:0; margin-bottom:60px; }
        .risco-bottom { margin:10px 0 0 0; }
        .signature-section { display:inline-block; text-align:center; width:220px; }
        .signature-section .line { display:block; border-top:1px solid #000; padding-top:6px; }
        .date-container { text-align:right; margin-top:10px; }
    </style>
</head>
<body>
    <h2>Gerador de Laudo / Orçamento</h2>
    <div class="app">
        <div class="panel">
            <label>Data</label>
            <div class="row">
                <input id="date" type="text">
                <button id="useNow" class="btn ghost">Usar hoje</button>
            </div>
            <label>Tipo</label>
            <select id="tipo">
                <option value="LAUDO">Laudo Técnico</option>
                <option value="ORCAMENTO">Orçamento</option>
            </select>
            <label>Nome do Cliente</label>
            <input id="cliente" type="text">
            <label>Contato</label>
            <input id="contato" type="text">
            <label>Endereço - Rua</label>
            <input id="rua" type="text">
            <div class="row">
                <div style="flex:1"><label>Nº</label><input id="numero" type="text"></div>
                <div style="flex:1"><label>Bairro</label><input id="bairro" type="text"></div>
            </div>
            <label>Cidade</label>
            <input id="cidade" type="text">
            <label>Descrição</label>
            <textarea id="descricao"></textarea>
            <button id="gerar" class="btn">Salvar em PDF</button>
            <button id="limpar" class="btn ghost">Limpar</button>
        </div>

        <div class="preview">
            <div class="paper" id="paper">
                <div class="header">
                    <img src="/foto-jdc.jpg" alt="Logo" id="logoImg">
                    <div class="company">
                        JDC Climatização<br>
                        <span style="font-size:12px">Cleiton Munzfeld me <br> Rua Israel de Almeida 884<br>Contato: 47 99663-5527</span>
                    </div>
                </div>
                <div class="section"><strong>Cliente:</strong> <span id="clientePreview">-</span></div>
                <div class="section"><strong>Contato:</strong> <span id="contatoPreview">-</span></div>
                <div class="section"><strong>Endereço:</strong> <span id="endPreview">-</span></div>
                <div class="risco"></div>
                <div class="title-row">
                    <div class="title" id="tipoPreview">LAUDO TÉCNICO</div>
                    <div class="section"><strong>Data:</strong> <span id="metaData">--/--/----</span></div>
                </div>
                <div class="risco"></div>
                <div class="section"><strong>Descrição:</strong><div id="descPreview" style="min-height:150px; margin-top:10px;">-</div></div>
                <div class="footer-container">
                    <div class="risco risco-top"></div>
                    <div class="signature-section">
                        <div class="line"></div>
                        <div>Assinatura</div>
                    </div>
                    <div class="risco risco-bottom"></div>
                    <div class="date-container" id="fullDate"></div>
                </div>
            </div>
        </div>
    </div>

<script>
const $ = id => document.getElementById(id)

function formatDateBR(d = new Date()) {
    const day = String(d.getDate()).padStart(2,'0')
    const month = String(d.getMonth()+1).padStart(2,'0')
    const year = d.getFullYear()
    return `${day}/${month}/${year}`
}

function formatFullDateBR(d = new Date()) {
    const options = { weekday:'long', day:'numeric', month:'long', year:'numeric' }
    const formatted = d.toLocaleDateString('pt-BR', options)
    return formatted.charAt(0).toUpperCase() + formatted.slice(1)
}

$('date').value = formatDateBR()
$('useNow').addEventListener('click', ()=>{
    $('date').value = formatDateBR()
    updatePreview()
})

const fields = ['tipo','cliente','contato','rua','numero','bairro','cidade','descricao']
fields.forEach(f => $(f).addEventListener('input', updatePreview))

function updatePreview() {
    $('clientePreview').innerText = $('cliente').value || '-'
    $('contatoPreview').innerText = $('contato').value || '-'
    const rua = $('rua').value || '-'
    const num = $('numero').value || ''
    const bairro = $('bairro').value || '-'
    const cidade = $('cidade').value || '-'
    $('endPreview').innerText = rua + (num?(', nº '+num):'') + ' — ' + cidade + ' - ' + bairro
    $('descPreview').innerText = $('descricao').value || '-'
    $('tipoPreview').innerText = $('tipo').value==='LAUDO'?'LAUDO TÉCNICO':'ORÇAMENTO'
    $('metaData').innerText = $('date').value || formatDateBR()
    $('fullDate').innerText = formatFullDateBR()
}

updatePreview()

$('limpar').addEventListener('click', ()=>{
    fields.forEach(f=>$(f).value='')
    $('date').value = formatDateBR()
    updatePreview()
})

$('gerar').addEventListener('click', ()=>{
    const paper = $('paper')
    const logo = $('logoImg')

    // Espera a imagem carregar
    const gerarPDF = ()=>{
        html2canvas(paper, { scale: 2 }).then(canvas=>{
            const { jsPDF } = window.jspdf
            const pdf = new jsPDF('p','mm','a4')
            const imgData = canvas.toDataURL('image/png')
            const imgWidth = 210
            const pageHeight = 297
            const imgHeight = canvas.height * imgWidth / canvas.width
            let heightLeft = imgHeight
            let position = 0

            pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight)
            heightLeft -= pageHeight

            while(heightLeft>=0){
                position = heightLeft - imgHeight
                pdf.addPage()
                pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight)
                heightLeft -= pageHeight
            }

            const tipoDoc = $('tipo').value==='LAUDO'?'laudo':'orcamento'
            const clienteNome = ($('cliente').value?$('cliente').value.replace(/\s+/g,'_'):'documento')
            const fileName = `${tipoDoc}_${clienteNome}.pdf`

            pdf.save(fileName)
        })
    }

    if(logo.complete){
        gerarPDF()
    } else {
        logo.onload = gerarPDF
    }
})
</script>
</body>
</html>
